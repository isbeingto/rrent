// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * 组织隔离与角色枚举
 * 用于后续 Tenant/Org/User 之间的权限与视图隔离
 */
enum OrgRole {
  OWNER
  PROPERTY_MGR
  OPERATOR
  STAFF
}

/**
 * 房源/单元状态
 */
enum UnitStatus {
  VACANT
  RESERVED
  OCCUPIED
  MAINTENANCE
  OFFLINE
}

/**
 * 租约状态
 */
enum LeaseStatus {
  DRAFT
  PENDING
  ACTIVE
  TERMINATED
  EXPIRED
}

/**
 * 账单类型（按费用种类）
 */
enum BillType {
  RENT
  DEPOSIT
  UTILITIES
  SERVICE
  PENALTY
  OTHER
}

/**
 * 账单周期（按出账频率）
 */
enum BillCycle {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

/**
 * 支付状态
 */
enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELED
}

/**
 * 支付方式
 */
enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
  ONLINE
}

/**
 * 多租户隔离的核心实体
 * 代表一个物业公司 / 运营方 / 房源管理主体
 */
model Organization {
  id          String  @id @default(uuid())
  name        String
  code        String  @unique
  description String? @db.Text

  timezone String  @default("Asia/Shanghai")
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  properties Property[]
  tenants    Tenant[]
  leases     Lease[]

  @@index([name])
}

/**
 * 公寓/楼盘/小区资产项目
 * 每个 Organization 下可以有多个 Property
 */
model Property {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name        String
  code        String
  description String? @db.Text

  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String? @default("CN")

  timezone String  @default("Asia/Shanghai")
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  units  Unit[]
  leases Lease[]

  @@unique([organizationId, code])
  @@index([organizationId, name])
}

/**
 * 具体房源单元/房间
 * 每个 Property 下可以有多个 Unit
 */
model Unit {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  name       String?
  unitNumber String
  floor      Int?
  bedrooms   Int?
  bathrooms  Int?
  areaSqm    Float?

  status   UnitStatus @default(VACANT)
  isActive Boolean    @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leases Lease[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId, status])
}

/**
 * 租客/承租人实体
 * 每个 Tenant 属于一个 Organization
 */
model Tenant {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  fullName String
  email    String?
  phone    String?
  idNumber String?
  notes    String? @db.Text

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leases Lease[]

  @@unique([organizationId, email])
  @@unique([organizationId, phone])
  @@index([organizationId, fullName])
}

/**
 * 租约/合同核心业务实体
 * 关联 Organization、Property、Unit、Tenant
 */
model Lease {
  id String @id @default(uuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  status    LeaseStatus @default(PENDING)
  billCycle BillCycle   @default(MONTHLY)

  startDate DateTime
  endDate   DateTime?

  rentAmount    Decimal  @db.Decimal(10, 2)
  currency      String   @default("CNY")
  depositAmount Decimal? @db.Decimal(10, 2)

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([unitId, status])
  @@index([organizationId, status])
  @@index([tenantId, status])
}
