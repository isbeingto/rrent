# =============================================================================
# Render.com Deployment Configuration
# =============================================================================
# Blueprint spec for deploying RRent backend to Render
# Documentation: https://render.com/docs/blueprint-spec
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  - type: pserv
    name: rrent-postgres
    plan: starter  # Free tier available
    region: oregon  # Choose your region
    ipAllowList: []  # Empty = allow all IPs
    databaseName: rrent_production
    databaseUser: rrent_user

  # ---------------------------------------------------------------------------
  # Backend API Service
  # ---------------------------------------------------------------------------
  - type: web
    name: rrent-backend
    runtime: docker
    plan: starter  # Free tier available (750 hours/month)
    region: oregon  # Must match database region
    branch: main
    
    # Docker build configuration
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    
    # Environment variables
    envVars:
      # Node environment
      - key: NODE_ENV
        value: production
      
      # Application
      - key: PORT
        value: 3000
      
      - key: APP_VERSION
        value: 1.0.0
      
      # Database connection (auto-generated from postgres service)
      - key: DATABASE_URL
        fromDatabase:
          name: rrent-postgres
          property: connectionString
      
      # Authentication & Security
      # ⚠️ IMPORTANT: Generate these values securely!
      - key: JWT_SECRET
        generateValue: true  # Render will generate a random value
        sync: false
      
      - key: JWT_EXPIRES_IN
        value: 7d
      
      - key: BCRYPT_ROUNDS
        value: 12
      
      # Rate limiting
      - key: THROTTLE_TTL
        value: 60
      
      - key: THROTTLE_LIMIT
        value: 100
      
      # CORS (update with your frontend domain)
      - key: CORS_ORIGIN
        value: "*"
      
      # Logging
      - key: LOG_LEVEL
        value: info
      
      - key: LOG_FORMAT
        value: json
      
      # Timezone
      - key: TZ
        value: Asia/Shanghai
    
    # Health check configuration
    healthCheckPath: /health/ready
    
    # Auto-deploy settings
    autoDeploy: true
    
    # Build command (optional, Dockerfile handles this)
    # buildCommand: npm run build
    
    # Start command (defined in Dockerfile)
    # startCommand: node dist/main
